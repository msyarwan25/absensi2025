<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Siswa - SMP NEGERI BINUANG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for body and fonts */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Lighter blue-gray background */
            color: #334155; /* Darker text for better contrast */
        }
        .header-title {
            font-family: 'Poppins', sans-serif;
        }

        /* General button styling */
        .btn {
            transition: all 0.3s ease;
            border-radius: 0.5rem; /* Rounded corners for all buttons */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* More pronounced shadow on hover */
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* Light gray track */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* Medium gray thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Darker gray on hover */
        }

        /* Hide and show views */
        .view {
            display: none;
            animation: fadeIn 0.5s ease-out; /* Fade in animation for views */
        }
        .view.active {
            display: block;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom radio button styling for attendance status */
        .custom-radio-label {
            position: relative; /* Needed for absolute positioning of input */
            display: inline-flex; /* To allow flex properties */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
        }

        .custom-radio-label input[type="radio"] {
            /* Hide the default radio button */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: absolute; /* Position absolutely to hide it but keep it interactive */
            opacity: 0;
            width: 100%; /* Make it cover the label for clicks */
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1; /* Ensure it's above the indicator for click events */
        }

        .custom-radio-label .custom-radio-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px; /* Increased width to fit full words */
            height: 36px; /* Consistent height */
            padding: 0 12px; /* Add horizontal padding */
            border: 2px solid #cbd5e1; /* Default border color */
            border-radius: 9999px; /* Full rounded for pill shape */
            background-color: #f8fafc; /* Default background */
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* Default text color */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Softer shadow */
            white-space: nowrap; /* Prevent text wrapping */
        }

        /* Styles for checked state */
        .custom-radio-label input[type="radio"]:checked + .custom-radio-indicator {
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* More prominent shadow when checked */
            transform: scale(1.05); /* Slight scale up when checked */
        }

        /* Specific colors for each status when checked */
        .custom-radio-label input[type="radio"][value="Hadir"]:checked + .custom-radio-indicator {
            background-color: #10b981; /* Emerald green for Hadir */
        }
        .custom-radio-label input[type="radio"][value="Sakit"]:checked + .custom-radio-indicator {
            background-color: #f59e0b; /* Amber yellow for Sakit */
        }
        .custom-radio-label input[type="radio"][value="Izin"]:checked + .custom-radio-indicator {
            background-color: #3b82f6; /* Royal blue for Izin */
        }
        .custom-radio-label input[type="radio"][value="Alfa"]:checked + .custom-radio-indicator {
            background-color: #ef4444; /* Strong red for Alfa */
        }

        /* Hover effect */
        .custom-radio-label .custom-radio-indicator:hover {
            transform: scale(1.08); /* Slightly more scale on hover */
            border-color: #94a3b8;
            background-color: #e2e8f0; /* Subtle background change on hover */
        }
        .custom-radio-label input[type="radio"]:checked + .custom-radio-indicator:hover {
            transform: scale(1.1); /* Even more scale for checked on hover */
            opacity: 0.9;
        }

        /* Table styling */
        .table-container {
            border-radius: 0.75rem; /* More rounded corners for the table container */
            overflow: hidden; /* Ensures rounded corners clip content */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Stronger shadow for the table */
        }
        .min-w-full {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on cells */
            border-spacing: 0; /* Remove space between cells */
        }
        .min-w-full th, .min-w-full td {
            padding: 1rem 1.25rem; /* Increased padding for table cells */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Lighter border for rows */
        }
        .min-w-full th {
            background-color: #f1f5f9; /* Light gray header background */
            font-size: 0.8rem; /* Slightly smaller font for headers */
            color: #475569; /* Darker gray for header text */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }
        .min-w-full tbody tr:last-child td {
            border-bottom: none; /* No border on the last row */
        }
        /* Table row alternating background and hover */
        #recap-table-body tr:nth-child(odd) {
            background-color: #ffffff; /* White for odd rows */
        }
        #recap-table-body tr:nth-child(even) {
            background-color: #f8fafc; /* Lighter alternating row */
        }
        #recap-table-body tr:hover {
            background-color: #e0f2fe; /* Light blue on hover */
            transition: background-color 0.2s ease-in-out;
        }

        /* Input and select field styling */
        input[type="text"],
        input[type="date"],
        select {
            border-radius: 0.5rem; /* Consistent rounded corners */
            padding: 0.65rem 1rem; /* Slightly more padding */
            border: 1px solid #d1d5db; /* Lighter border */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* Inner shadow for depth */
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #3b82f6; /* Blue focus ring */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* Softer focus ring */
            outline: none;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="min-h-screen container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header class="bg-white rounded-xl shadow-lg p-6 mb-8 border-b-4 border-blue-500">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="header-title text-3xl md:text-4xl font-bold text-blue-700">SMP NEGERI BINUANG</h1>
                    <p class="text-gray-600 text-lg mt-1">Sistem Absensi Siswa Digital</p>
                </div>
                <div id="clock" class="text-right mt-4 md:mt-0 bg-blue-50 p-3 rounded-lg shadow-inner">
                    <p class="font-semibold text-xl text-blue-800" id="time-display"></p>
                    <p class="text-sm text-gray-600" id="date-display"></p>
                </div>
            </div>
            <!-- Navigation Buttons -->
            <nav class="mt-8 border-t pt-6 flex flex-wrap gap-4 justify-center md:justify-start">
                <button id="nav-absen" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 shadow-md">
                    Input Absensi
                </button>
                <button id="nav-rekap" class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6">
                    Rekap Absensi
                </button>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Absensi View (Default Active) -->
            <div id="view-absen" class="view active">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 pb-3 border-b-2 border-gray-200 text-blue-700">Formulir Absensi Siswa</h2>
                    <form id="attendance-form">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div>
                                <label for="class-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                                <select id="class-select" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Pilih Kelas --</option>
                                    <option value="VII.1">VII.1</option>
                                    <option value="VII.2">VII.2</option>
                                    <option value="VIII.1">VIII.1</option>
                                    <option value="VIII.2">VIII.2</option>
                                    <option value="IX.1">IX.1</option>
                                    <option value="IX.2">IX.2</option>
                                </select>
                            </div>
                            <div>
                                <label for="subject-select" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="subject-select" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option>IPA</option>
                                    <option>INFORMATIKA</option>
                                    <option>MATEMATIKA</option>
                                    <option>BAHASA INDONESIA</option>
                                    <option>BAHASA INGGRIS</option>
                                    <option>PENDIDIKAN AGAMA</option>
                                    <option>PJOK</option>
                                    <option>SENI BUDAYA</option>
                                    <option>IPS</option>
                                    <option>PPKN</option>
                                </select>
                            </div>
                            <div>
                                <label for="date-input" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="date-input" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div id="student-list-container" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-center text-gray-500 py-4">Silakan pilih kelas untuk menampilkan daftar siswa.</p>
                        </div>
                        
                        <div class="mt-10 flex justify-end">
                            <button type="submit" id="submit-button" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 px-8 shadow-xl flex items-center">
                                <svg id="submit-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span id="submit-text">Simpan Absensi</span>
                                <svg id="submit-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                            </button>
                        </div>
                    </form>
                    <div id="status-message" class="mt-6 text-center text-lg"></div>
                </div>
            </div>

            <!-- Rekap View -->
            <div id="view-rekap" class="view">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 pb-3 border-b-2 border-gray-200 text-blue-700">Rekapitulasi Absensi</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="filter-class" class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label>
                            <select id="filter-class" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Semua Kelas --</option>
                                <option value="VII.1">VII.1</option>
                                <option value="VII.2">VII.2</option>
                                <option value="VIII.1">VIII.1</option>
                                <option value="VIII.2">VIII.2</option>
                                <option value="IX.1">IX.1</option>
                                <option value="IX.2">IX.2</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-subject" class="block text-sm font-medium text-gray-700 mb-2">Filter Mata Pelajaran</label>
                            <select id="filter-subject" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Semua Mata Pelajaran --</option>
                                <option>IPA</option>
                                <option>INFORMATIKA</option>
                                <option>MATEMATIKA</option>
                                <option>BAHASA INDONESIA</option>
                                <option>BAHASA INGGRIS</option>
                                <option>PENDIDIKAN AGAMA</option>
                                <option>PJOK</option>
                                <option>SENI BUDAYA</option>
                                <option>IPS</option>
                                <option>PPKN</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-name" class="block text-sm font-medium text-gray-700 mb-2">Filter Nama Siswa</label>
                            <input type="text" id="filter-name" placeholder="Ketik nama untuk mencari..." class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-1 lg:col-span-1">
                            <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-2">Filter Tanggal</label>
                            <input type="date" id="filter-date" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- Student/Class summary section -->
                    <div id="recap-summary" class="hidden mb-6 bg-blue-100 border border-blue-300 p-5 rounded-lg shadow-md transition-all duration-500 ease-in-out">
                        <h3 class="text-xl font-bold text-blue-800 mb-4"><span id="summary-title">Ringkasan</span>: <span id="summary-target-name" class="text-blue-900"></span></h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-green-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-green-800" id="summary-hadir">0</p>
                                <p class="text-base font-medium text-green-700 mt-1">Hadir</p>
                            </div>
                            <div class="bg-yellow-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-yellow-800" id="summary-sakit">0</p>
                                <p class="text-base font-medium text-yellow-700 mt-1">Sakit</p>
                            </div>
                            <div class="bg-blue-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-blue-800" id="summary-izin">0</p>
                                <p class="text-base font-medium text-blue-700 mt-1">Izin</p>
                            </div>
                            <div class="bg-red-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-red-800" id="summary-alfa">0</p>
                                <p class="text-base font-medium text-red-700 mt-1">Alfa</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end mb-4">
                        <!-- Perhatian: URL ini mungkin perlu diperbarui agar sesuai dengan Google Sheet Anda -->
                        <a href="https://docs.google.com/spreadsheets/d/145HIPY1JPtt7KLaXvvfJ6Z6D669zxhmStpbNc-5u1sw/edit?gid=0#gid=0" target="_blank" class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-6 shadow-md flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            Lihat Data Mentah (Google Sheet)
                        </a>
                    </div>

                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NIS</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Lengkap</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ket.</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kelas</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Mata Pelajaran</th>
                                </tr>
                            </thead>
                            <tbody id="recap-table-body">
                                <!-- Data akan dimuat di sini -->
                            </tbody>
                            <div id="recap-loading" class="text-center py-8">
                                <p class="text-gray-500">Memuat data rekapitulasi...</p>
                            </div>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA SISWA (HARAP SESUAIKAN JIKA DIPERLUKAN) ---
        const studentsData = {
            'VII.1': [
                { nis: '1', nama: 'AURA IDRIS' }, { nis: '2', nama: 'AHMAD FAUZAN' }, { nis: '3', nama: 'AHMAD HIDAYAT' },
                { nis: '4', nama: 'ANUGRAH HAYU' }, { nis: '5', nama: 'ATIKA DEFI' }, { nis: '6', nama: 'AZILA AZZAHRA' },
                { nis: '7', nama: 'KHASRAPUL HABIB' }, { nis: '8', nama: 'MUH.AIMAN SYAH' }, { nis: '9', nama: 'MUH.ALIF' },
                { nis: '10', nama: 'MUH.ANUGRAH' }, { nis: '11', nama: 'MUH.ARYA' }, { nis: '12', nama: 'MUH.RAMADHAN RUSMAN' },
                { nis: '13', nama: 'MUHAMMAD IMRAN' }, { nis: '14', nama: 'NABILA' }, { nis: '15', nama: 'NUR ANIDA NURDIN' },
                { nis: '16', nama: 'NUR AZILAH' }, { nis: '17', nama: 'NURUL ANNISA' }, { nis: '18', nama: 'RITA PARADIBA' },
                { nis: '19', nama: 'SUKUR' }, { nis: '20', nama: 'SYAFIRA' }, { nis: '21', nama: 'ZAKHWAN AHMAD NOVAL' },
                { nis: '22', nama: 'NUR AKILA' },
                { nis: '23', nama: 'MUH. FIKRI AQLANY' }
            ],
            'VII.2': [
                { nis: '1', nama: 'ALIM FIKRI' }, { nis: '2', nama: 'ALYA ARFAN' }, { nis: '3', nama: 'ANUGRAH NURUSTAZAH' },
                { nis: '4', nama: 'DIAN VIRGINIA ARNA' }, { nis: '5', nama: 'DUL JALAL WAL IKRAM' }, { nis: '6', nama: 'JASYAN GALBYANA' },
                { nis: '7', nama: 'MUH.ADAM AL FATIH' }, { nis: '8', nama: 'MUH.FARDAN' }, { nis: '9', nama: 'MUH.HARDYAN' },
                { nis: '10', nama: 'MUH.IKZAN' }, { nis: '11', nama: 'MUH.MULIADI' }, { nis: '12', nama: 'MUH.REZKY' },
                { nis: '13', nama: 'MUHAMMAD DWI FARHAN' }, { nis: '14', nama: 'MUHAMMAD FADLI ADRIAN' }, { nis: '15', nama: 'MUHAMMAD SULFIANDI' },
                { nis: '16', nama: 'NASRAH' }, { nis: '17', nama: 'NIRMADANI SAFITRI' }, { nis: '18', nama: 'NUR AZMITA' },
                { nis: '19', nama: 'NURHALIZA' }, { nis: '20', nama: 'SALDI FEBRIANSA' }, { nis: '21', nama: 'YENI ANGRENI' }, { nis: '22', nama: 'ZASKIA GAMA' }
            ],
            'VIII.1': [
                { nis: '2024342', nama: 'A. BESSE INTAN GALI GALI' }, { nis: '2024343', nama: 'ALDI' }, { nis: '2024344', nama: 'ANDI CAHAYA RAMADHANI, AJ' },
                { nis: '2024345', nama: 'ANDI MAHERA' }, { nis: '2024346', nama: 'FAISAL' }, { nis: '2024347', nama: 'FIRMANSYAH' },
                { nis: '2024348', nama: 'HASTATI' }, { nis: '2024349', nama: 'IRFANSYAH IBRAHIM' }, { nis: '2024350', nama: 'LESTARI' },
                { nis: '2024351', nama: 'M. RIJAL' }, { nis: '2024352', nama: 'MUH. MULYA' }, { nis: '2024353', nama: 'MUHAMMAD ASWAR ALHABSI' },
                { nis: '2024354', nama: 'MUHAMMAD FIKRAN' }, { nis: '2024355', nama: 'MUHAMMAD RIFKI LUKMAN' }, { nis: '2024356', nama: 'NURWAVIA' },
                { nis: '2024357', nama: 'PUTRI YASMIN' }, { nis: '2024358', nama: 'RIZKI FAHRI ANUGRAH' }, { nis: '2024359', nama: 'SAMSIR' },
                { nis: '2024360', nama: 'SITI NUR AZZAHRAH' }, { nis: '2024361', nama: 'SITI NURUL SYAFIQAH' }, { nis: '2024379', nama: 'ZASKIA APRILIA' }
            ],
            'VIII.2': [
                { nis: '2024361', nama: 'AENI' }, { nis: '2024362', nama: 'AL IKRAM' }, { nis: '2024363', nama: 'AUREL' },
                { nis: '2024364', nama: 'DEVI ALDIANTI' }, { nis: '2024365', nama: 'ERSYA ANATASYA' }, { nis: '2024366', nama: 'HALIFAH AMIRUDDIN' },
                { nis: '2024367', nama: 'INTAN' }, { nis: '2024368', nama: 'MUH. ALIF' }, { nis: '2024369', nama: 'MUHAMMAD AIMAN' },
                { nis: '2024370', nama: 'MUHAMMAD NASRIL' }, { nis: '2024371', nama: 'MUHAMMAD REZA ANWAR' }, { nis: '2024372', nama: 'NABILA' },
                { nis: '2024373', nama: 'NATASYA' }, { nis: '2024374', nama: 'NURUL AINUN SAKINAH' }, { nis: '2024375', 'nama': 'PERDI' },
                { nis: '2024376', nama: 'REZKY' }, { nis: '2024377', nama: 'SHOHIH MUSLIM ABI AKBAR' }, { nis: '2024378', nama: 'TINA INDRISARI' },
                { nis: '2025378', nama: 'ABDUL MULIADIL' }, { nis: '2025376', nama: 'MUHAMMAD HAIKAL' }
            ],
            'IX.1': [
                { nis: '2024339', nama: 'ADELIA MARWAH' }, { nis: '2023335', nama: 'AFGAN' }, { nis: '2023296', nama: 'ALFIYA SYAHRANI' },
                { nis: '2023330', nama: 'ALYA REGINA' }, { nis: '2023298', nama: 'ARIF' }, { nis: '2023300', nama: 'BUNGA CITRA LESTARI' },
                { nis: '2023303', nama: 'IKRAM' }, { nis: '2023307', nama: 'MUH.ANDRI ILHAM' }, { nis: '2023331', nama: 'MUH.DAVID' },
                { nis: '2023308', nama: 'MUH.SYASWI GAISAN' }, { nis: '2023329', nama: 'MUHAMMAD RESKI' }, { nis: '2024338', nama: 'NUR FITRI' },
                { nis: '2023316', nama: 'NUR AENI' }, { nis: '2023319', nama: 'NUR HIKMAH' }, { nis: '2023321', nama: 'NURUL AZIZAH SULTAN' },
                { nis: '2023322', nama: 'NURUL MUTMAINNA' }, { nis: '2023323', nama: 'PATIMURA' }, { nis: '2023324', nama: 'RAHMANIA' },
                { nis: '2023326', nama: 'SALSABILA' }, { nis: '2023332', nama: 'SATRIADI' }
            ],
            'IX.2': [
                { nis: '2023295', nama: 'AISYAH NUR MAULIDYA' }, { nis: '2023297', nama: 'ANDI AHMAD DENI' }, { nis: '2023299', nama: 'AURAH ZAKINA' },
                { nis: '2024337', nama: 'HAFIZHA TULFALIHA' }, { nis: '2023302', nama: 'HUSNUL MUBARAK' }, { nis: '2023304', nama: 'JUMALIA' },
                { nis: '2023306', nama: 'MAWAR INDAH LESTARI' }, { nis: '2023310', nama: 'MUHAMMAD ADITYA' }, { nis: '2023311', nama: 'MUHAMMAD DAVID' },
                { nis: '2023312', nama: 'MUHAMMAD FAUSY' }, { nis: '2023313', nama: 'MUHD.RAFI' }, { nis: '2023314', nama: 'MULYANI SAFITRA' },
                { nis: '2023318', nama: 'NUR HASNA' }, { nis: '2023320', nama: 'NUR SAHIRA' }, { nis: '2023325', nama: 'RAHMAT HIDAYAT' },
                { nis: '2023327', nama: 'SASKIA RAMADANI' }, { nis: '2024340', nama: 'MUH. RIZKY' }, { nis: '2024372', nama: 'Muh Fauzan' },
                { nis: '2024371', nama: 'FITRA RAMADANI' }, { nis: '2024373', nama: 'SISKA' }
            ]
        };

        // --- KONFIGURASI ---
        // URL Google Apps Script Anda yang baru
        const googleScriptURL = 'https://script.google.com/macros/s/AKfycbx53NQBkdHJV-G4AlCfvdWhcsFe_EKSEj47vyVxQImIqgnXpMqy1hgULOgqACCbVW8zgQ/exec';
        
        // URL untuk rekap data dari Google Sheet (CSV).
        // Perhatian: Ini adalah URL contoh. Anda harus membuat URL publikasi CSV dari Google Sheet Anda
        // dan menggantinya di sini. Pastikan sheet memiliki header yang sama dengan nama kolom di script Anda.
        const googleSheetRecapURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ27ncSSFBRM9qe1-Oc4Q4OL2USYZ5-zDgZS7Osyj7Yywv-BRda3ZLekf7fQPH-NO6d5E58hMbn2uuB/pub?gid=0&single=true&output=csv';
        // URL untuk melihat Google Sheet mentah Anda
        const rawGoogleSheetURL = 'https://docs.google.com/spreadsheets/d/145HIPY1JPtt7KLaXvvfJ6Z6D669zxhmStpbNc-5u1sw/edit?gid=0#gid=0';

        // --- DOM ELEMENTS ---
        const classSelect = document.getElementById('class-select');
        const subjectSelect = document.getElementById('subject-select'); // Added subject select
        const studentListContainer = document.getElementById('student-list-container');
        const attendanceForm = document.getElementById('attendance-form');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const statusMessage = document.getElementById('status-message');
        const dateInput = document.getElementById('date-input');

        const navAbsen = document.getElementById('nav-absen');
        const navRekap = document.getElementById('nav-rekap');
        const viewAbsen = document.getElementById('view-absen');
        const viewRekap = document.getElementById('view-rekap');

        const recapTableBody = document.getElementById('recap-table-body');
        const recapLoading = document.getElementById('recap-loading');
        const filterClass = document.getElementById('filter-class');
        const filterSubject = document.getElementById('filter-subject');
        const filterName = document.getElementById('filter-name');
        const filterDate = document.getElementById('filter-date');
        const recapSummary = document.getElementById('recap-summary');
        const summaryTitle = document.getElementById('summary-title');
        const summaryTargetName = document.getElementById('summary-target-name');
        const summaryHadir = document.getElementById('summary-hadir');
        const summarySakit = document.getElementById('summary-sakit');
        const summaryIzin = document.getElementById('summary-izin');
        const summaryAlfa = document.getElementById('summary-alfa');
        
        let allRecapData = [];

        // --- FUNGSI JAM & TANGGAL (WITA) ---
        /**
         * Updates the clock and date display in the header.
         * Displays time in WITA (Central Indonesia Time).
         */
        function updateClock() {
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            
            const now = new Date();
            const optionsTime = { timeZone: 'Asia/Makassar', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const optionsDate = { timeZone: 'Asia/Makassar', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            timeDisplay.textContent = `WITA: ${new Intl.DateTimeFormat('id-ID', optionsTime).format(now)}`;
            dateDisplay.textContent = new Intl.DateTimeFormat('id-ID', optionsDate).format(now);
        }

        // --- FUNGSI UTAMA APLIKASI ---

        /**
         * Populates the student list table based on the selected class.
         * Enables/disables the submit button accordingly.
         */
        function populateStudentList() {
            const selectedClass = classSelect.value;
            if (!selectedClass) {
                studentListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Silakan pilih kelas untuk menampilkan daftar siswa.</p>';
                submitButton.disabled = true;
                return;
            }

            const students = studentsData[selectedClass];
            const statusOptions = ['Hadir', 'Sakit', 'Izin', 'Alfa'];

            let tableHTML = `
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="w-12 px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">NIS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nama Lengkap</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
            `;

            students.forEach((student, index) => {
                tableHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${index + 1}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${student.nis}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex items-center justify-center space-x-2">
                `;
                statusOptions.forEach(status => {
                    const isChecked = status === 'Hadir' && selectedClass;
                    tableHTML += `
                                <label class="custom-radio-label">
                                    <input type="radio" name="attendance-${student.nis}" value="${status}" ${isChecked ? 'checked' : ''} required>
                                    <span class="custom-radio-indicator">${status}</span>
                                </label>
                    `;
                });
                tableHTML += `
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            studentListContainer.innerHTML = tableHTML;
            submitButton.disabled = false;
        }

        /**
         * Handles the form submission for attendance.
         * Collects data and sends each student's record to Google Apps Script.
         * The new logic sends each record as a separate form submission.
         */
        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            submitButton.disabled = true;
            submitText.classList.add('hidden');
            submitSpinner.classList.remove('hidden');
            statusMessage.textContent = ''; // Clear previous messages

            const selectedClass = classSelect.value;
            const selectedSubject = subjectSelect.value;
            const selectedDate = dateInput.value;

            if (!selectedClass || !selectedSubject || !selectedDate) {
                statusMessage.textContent = 'Harap lengkapi semua bidang (Kelas, Mata Pelajaran, Tanggal).';
                statusMessage.className = 'mt-6 text-center text-lg text-red-600 font-semibold';
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                return;
            }

            const students = studentsData[selectedClass];
            const attendanceRecords = [];

            students.forEach(student => {
                const statusElement = document.querySelector(`input[name="attendance-${student.nis}"]:checked`);
                if (statusElement) {
                    attendanceRecords.push({
                        nis: student.nis,
                        nama: student.nama,
                        kelas: selectedClass,
                        mata_pelajaran: selectedSubject,
                        tanggal: selectedDate,
                        keterangan: statusElement.value
                    });
                }
            });

            if (attendanceRecords.length === 0) {
                statusMessage.textContent = 'Tidak ada data absensi yang dipilih. Harap pilih status absensi untuk setiap siswa.';
                statusMessage.className = 'mt-6 text-center text-lg text-red-600 font-semibold';
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
                return;
            }
            
            let successCount = 0;
            let errorCount = 0;

            try {
                for (const record of attendanceRecords) {
                    const params = new URLSearchParams({
                        'NIS': record.nis,
                        'Nama Lengkap': record.nama,
                        'Tanggal Absen': record.tanggal,
                        'Keterangan': record.keterangan,
                        'Kelas': record.kelas,
                        'Mata Pelajaran': record.mata_pelajaran
                    });

                    // Tampilkan status pengiriman per siswa
                    statusMessage.textContent = `Mengirim data absensi untuk ${record.nama}...`;
                    statusMessage.className = 'mt-6 text-center text-lg text-blue-600 font-semibold';

                    // Mengirim data sebagai form URL-encoded
                    const response = await fetch(googleScriptURL, {
                        method: 'POST',
                        body: params
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                }
                
                // Tampilkan pesan akhir setelah semua permintaan selesai
                if (errorCount === 0) {
                    statusMessage.textContent = `Absensi untuk ${successCount} siswa berhasil disimpan!`;
                    statusMessage.className = 'mt-6 text-center text-lg text-green-600 font-semibold';
                    attendanceForm.reset(); // Reset form
                    populateStudentList(); // Re-populate to clear selections
                } else {
                    statusMessage.textContent = `Absensi berhasil disimpan untuk ${successCount} siswa, tetapi gagal untuk ${errorCount} siswa.`;
                    statusMessage.className = 'mt-6 text-center text-lg text-yellow-600 font-semibold';
                }

            } catch (error) {
                console.error('Error submitting attendance:', error);
                statusMessage.textContent = 'Terjadi kesalahan saat menyimpan absensi. Silakan coba lagi.';
                statusMessage.className = 'mt-6 text-center text-lg text-red-600 font-semibold';
            } finally {
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        });

        /**
         * Switches between the "Input Absensi" and "Rekap Absensi" views.
         * @param {string} viewId - The ID of the view to activate ('view-absen' or 'view-rekap').
         */
        function switchView(viewId) {
            viewAbsen.classList.remove('active');
            viewRekap.classList.remove('active');
            navAbsen.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'shadow-md');
            navAbsen.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            navRekap.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'shadow-md');
            navRekap.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');

            if (viewId === 'view-absen') {
                viewAbsen.classList.add('active');
                navAbsen.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'shadow-md');
                navAbsen.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            } else if (viewId === 'view-rekap') {
                viewRekap.classList.add('active');
                navRekap.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'shadow-md');
                navRekap.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                loadRecapData(); // Load recap data when switching to recap view
            }
        }

        // Event listeners for navigation buttons
        navAbsen.addEventListener('click', () => switchView('view-absen'));
        navRekap.addEventListener('click', () => switchView('view-rekap'));

        /**
         * Fetches attendance recap data from Google Sheet CSV export.
         */
        async function loadRecapData() {
            recapLoading.classList.remove('hidden');
            recapTableBody.innerHTML = ''; // Clear existing table
            recapSummary.classList.add('hidden'); // Hide summary until data is loaded/filtered

            try {
                // Perhatian: Ganti URL ini dengan URL publikasi CSV dari Google Sheet Anda
                const response = await fetch(googleSheetRecapURL);
                const csvText = await response.text();
                allRecapData = parseCSV(csvText);
                renderRecapTable(); // Render table with all data initially
            } catch (error) {
                console.error('Error loading recap data:', error);
                recapTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat data rekapitulasi.</td></tr>`;
            } finally {
                recapLoading.classList.add('hidden');
            }
        }

        /**
         * Parses CSV text into an array of objects.
         * Assumes the first row is the header.
         * @param {string} csv - The CSV data as a string.
         * @returns {Array<Object>} An array of objects representing the CSV data.
         */
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== ''); // Filter out empty lines
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    let row = {};
                    headers.forEach((header, index) => {
                        row[header.toLowerCase().replace(/\s/g, '_')] = values[index]; // Convert headers to snake_case
                    });
                    data.push(row);
                }
            }
            return data;
        }

        /**
         * Renders the recap table and updates the summary based on filtered data.
         */
        function renderRecapTable() {
            let filteredData = [...allRecapData]; // Create a mutable copy

            const selectedClass = filterClass.value;
            const selectedSubject = filterSubject.value;
            const searchName = filterName.value.toLowerCase();
            const selectedDate = filterDate.value;

            if (selectedClass) {
                filteredData = filteredData.filter(record => record.kelas === selectedClass);
            }
            if (selectedSubject) {
                filteredData = filteredData.filter(record => record.mata_pelajaran === selectedSubject);
            }
            if (searchName) {
                filteredData = filteredData.filter(record => record.nama_lengkap.toLowerCase().includes(searchName));
            }
            if (selectedDate) {
                filteredData = filteredData.filter(record => record.tanggal === selectedDate);
            }

            recapTableBody.innerHTML = ''; // Clear table before rendering
            if (filteredData.length === 0) {
                recapTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data absensi yang ditemukan.</td></tr>`;
                recapSummary.classList.add('hidden');
            } else {
                filteredData.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${record.nis}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.nama_lengkap}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.tanggal}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold ${
                            record.ket === 'Hadir' ? 'text-green-600' :
                            record.ket === 'Sakit' ? 'text-yellow-600' :
                            record.ket === 'Izin' ? 'text-blue-600' :
                            record.ket === 'Alfa' ? 'text-red-600' : ''
                        }">${record.ket}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.kelas}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.mata_pelajaran}</td>
                    `;
                    recapTableBody.appendChild(row);
                });
                updateRecapSummary(filteredData, selectedClass, searchName);
            }
        }

        /**
         * Updates the summary section with attendance counts.
         * @param {Array<Object>} data - The filtered attendance data.
         * @param {string} selectedClass - The currently selected class for filtering.
         * @param {string} searchName - The currently searched student name.
         */
        function updateRecapSummary(data, selectedClass, searchName) {
            const counts = { Hadir: 0, Sakit: 0, Izin: 0, Alfa: 0 };
            data.forEach(record => {
                if (counts.hasOwnProperty(record.ket)) {
                    counts[record.ket]++;
                }
            });

            summaryHadir.textContent = counts.Hadir;
            summarySakit.textContent = counts.Sakit;
            summaryIzin.textContent = counts.Izin;
            summaryAlfa.textContent = counts.Alfa;

            if (searchName) {
                summaryTitle.textContent = 'Ringkasan Absensi Siswa';
                summaryTargetName.textContent = filterName.value;
            } else if (selectedClass) {
                summaryTitle.textContent = 'Ringkasan Absensi Kelas';
                summaryTargetName.textContent = selectedClass;
            } else {
                summaryTitle.textContent = 'Ringkasan Absensi Keseluruhan';
                summaryTargetName.textContent = ''; // Clear if no specific class or name is filtered
            }
            recapSummary.classList.remove('hidden');
        }


        // Event listeners for recap filters
        filterClass.addEventListener('change', renderRecapTable);
        filterSubject.addEventListener('change', renderRecapTable);
        filterName.addEventListener('input', renderRecapTable); // Use 'input' for real-time filtering
        filterDate.addEventListener('change', renderRecapTable);

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set current date to the date input field
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;

            updateClock(); // Initial clock update
            setInterval(updateClock, 1000); // Update clock every second

            populateStudentList(); // Populate student list on initial load
            
            // Ensure the correct navigation button is active on load
            navAbsen.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'font-semibold', 'py-3', 'px-6', 'shadow-md');
            navAbsen.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
        });

        // Event listener for class selection change
        classSelect.addEventListener('change', populateStudentList);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Siswa - SMP NEGERI BINUANG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for body and fonts */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0; /* Lighter blue-gray background */
            color: #334155; /* Darker text for better contrast */
        }
        .header-title {
            font-family: 'Poppins', sans-serif;
        }

        /* General button styling */
        .btn {
            transition: all 0.3s ease;
            border-radius: 0.5rem; /* Rounded corners for all buttons */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Subtle shadow */
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); /* More pronounced shadow on hover */
        }

        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* Light gray track */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* Medium gray thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Darker gray on hover */
        }

        /* Hide and show views */
        .view {
            display: none;
            animation: fadeIn 0.5s ease-out; /* Fade in animation for views */
        }
        .view.active {
            display: block;
        }

        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom radio button styling for attendance status */
        .custom-radio-label {
            position: relative; /* Needed for absolute positioning of input */
            display: inline-flex; /* To allow flex properties */
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none; /* Prevent text selection */
        }

        .custom-radio-label input[type="radio"] {
            /* Hide the default radio button */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            position: absolute; /* Position absolutely to hide it but keep it interactive */
            opacity: 0;
            width: 100%; /* Make it cover the label for clicks */
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1; /* Ensure it's above the indicator for click events */
        }

        .custom-radio-label .custom-radio-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 60px; /* Increased width to fit full words */
            height: 36px; /* Consistent height */
            padding: 0 12px; /* Add horizontal padding */
            border: 2px solid #cbd5e1; /* Default border color */
            border-radius: 9999px; /* Full rounded for pill shape */
            background-color: #f8fafc; /* Default background */
            font-weight: 600;
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* Default text color */
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* Softer shadow */
            white-space: nowrap; /* Prevent text wrapping */
        }

        /* Styles for checked state */
        .custom-radio-label input[type="radio"]:checked + .custom-radio-indicator {
            color: white;
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* More prominent shadow when checked */
            transform: scale(1.05); /* Slight scale up when checked */
        }

        /* Specific colors for each status when checked */
        .custom-radio-label input[type="radio"][value="Hadir"]:checked + .custom-radio-indicator {
            background-color: #10b981; /* Emerald green for Hadir */
        }
        .custom-radio-label input[type="radio"][value="Sakit"]:checked + .custom-radio-indicator {
            background-color: #f59e0b; /* Amber yellow for Sakit */
        }
        .custom-radio-label input[type="radio"][value="Izin"]:checked + .custom-radio-indicator {
            background-color: #3b82f6; /* Royal blue for Izin */
        }
        .custom-radio-label input[type="radio"][value="Alfa"]:checked + .custom-radio-indicator {
            background-color: #ef4444; /* Strong red for Alfa */
        }

        /* Hover effect */
        .custom-radio-label .custom-radio-indicator:hover {
            transform: scale(1.08); /* Slightly more scale on hover */
            border-color: #94a3b8;
            background-color: #e2e8f0; /* Subtle background change on hover */
        }
        .custom-radio-label input[type="radio"]:checked + .custom-radio-indicator:hover {
            transform: scale(1.1); /* Even more scale for checked on hover */
            opacity: 0.9;
        }

        /* Table styling */
        .table-container {
            border-radius: 0.75rem; /* More rounded corners for the table container */
            overflow: hidden; /* Ensures rounded corners clip content */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Stronger shadow for the table */
        }
        .min-w-full {
            width: 100%;
            border-collapse: separate; /* Allows border-radius on cells */
            border-spacing: 0; /* Remove space between cells */
        }
        .min-w-full th, .min-w-full td {
            padding: 1rem 1.25rem; /* Increased padding for table cells */
            text-align: left;
            border-bottom: 1px solid #e2e8f0; /* Lighter border for rows */
        }
        .min-w-full th {
            background-color: #f1f5f9; /* Light gray header background */
            font-size: 0.8rem; /* Slightly smaller font for headers */
            color: #475569; /* Darker gray for header text */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
        }
        .min-w-full tbody tr:last-child td {
            border-bottom: none; /* No border on the last row */
        }
        /* Table row alternating background and hover */
        #recap-table-body tr:nth-child(odd), #subject-recap-table-body tr:nth-child(odd) {
            background-color: #ffffff; /* White for odd rows */
        }
        #recap-table-body tr:nth-child(even), #subject-recap-table-body tr:nth-child(even) {
            background-color: #f8fafc; /* Lighter alternating row */
        }
        #recap-table-body tr:hover, #subject-recap-table-body tr:hover {
            background-color: #e0f2fe; /* Light blue on hover */
            transition: background-color 0.2s ease-in-out;
        }

        /* Input and select field styling */
        input[type="text"],
        input[type="date"],
        select {
            border-radius: 0.5rem; /* Consistent rounded corners */
            padding: 0.65rem 1rem; /* Slightly more padding */
            border: 1px solid #d1d5db; /* Lighter border */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05); /* Inner shadow for depth */
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: #3b82f6; /* Blue focus ring */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* Softer focus ring */
            outline: none;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="min-h-screen container mx-auto p-4 md:p-8">
        <!-- Header Section -->
        <header class="bg-white rounded-xl shadow-lg p-6 mb-8 border-b-4 border-blue-500">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="header-title text-3xl md:text-4xl font-bold text-blue-700">SMP NEGERI BINUANG</h1>
                    <p class="text-gray-600 text-lg mt-1">Sistem Absensi Siswa Digital</p>
                </div>
                <div id="clock" class="text-right mt-4 md:mt-0 bg-blue-50 p-3 rounded-lg shadow-inner">
                    <p class="font-semibold text-xl text-blue-800" id="time-display"></p>
                    <p class="text-sm text-gray-600" id="date-display"></p>
                </div>
            </div>
            <!-- Navigation Buttons -->
            <nav class="mt-8 border-t pt-6 flex flex-wrap gap-4 justify-center md:justify-start">
                <button id="nav-absen" class="btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 shadow-md">
                    Input Absensi
                </button>
                <button id="nav-rekap" class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6">
                    Rekap Absensi Harian
                </button>
                <button id="nav-subject-rekap" class="btn bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6">
                    Rekap Per Mata Pelajaran
                </button>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main>
            <!-- Absensi View (Default Active) -->
            <div id="view-absen" class="view active">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 pb-3 border-b-2 border-gray-200 text-blue-700">Formulir Absensi Siswa</h2>
                    <form id="attendance-form">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div>
                                <label for="class-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                                <select id="class-select" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Pilih Kelas --</option>
                                    <option value="VII.1">VII.1</option>
                                    <option value="VII.2">VII.2</option>
                                    <option value="VIII.1">VIII.1</option>
                                    <option value="VIII.2">VIII.2</option>
                                    <option value="IX.1">IX.1</option>
                                    <option value="IX.2">IX.2</option>
                                </select>
                            </div>
                            <div>
                                <label for="subject-select" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <select id="subject-select" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <option>IPA</option>
                                    <option>INFORMATIKA</option>
                                    <option>MATEMATIKA</option>
                                    <option>BAHASA INDONESIA</option>
                                    <option>BAHASA INGGRIS</option>
                                    <option>PENDIDIKAN AGAMA</option>
                                    <option>PJOK</option>
                                    <option>SENI BUDAYA</option>
                                    <option>IPS</option>
                                    <option>PPKN</option>
                                </select>
                            </div>
                            <div>
                                <label for="date-input" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input type="date" id="date-input" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div id="student-list-container" class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <p class="text-center text-gray-500 py-4">Silakan pilih kelas untuk menampilkan daftar siswa.</p>
                        </div>
                        
                        <div class="mt-10 flex justify-end">
                            <button type="submit" id="submit-button" class="btn bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 px-8 shadow-xl flex items-center">
                                <svg id="submit-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                <span id="submit-text">Simpan Absensi</span>
                                <svg id="submit-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                            </button>
                        </div>
                    </form>
                    <div id="status-message" class="mt-6 text-center text-lg"></div>
                </div>
            </div>

            <!-- Rekap Harian View -->
            <div id="view-rekap" class="view">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 pb-3 border-b-2 border-gray-200 text-blue-700">Rekapitulasi Absensi Harian</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="filter-class" class="block text-sm font-medium text-gray-700 mb-2">Filter Kelas</label>
                            <select id="filter-class" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Semua Kelas --</option>
                                <option value="VII.1">VII.1</option>
                                <option value="VII.2">VII.2</option>
                                <option value="VIII.1">VIII.1</option>
                                <option value="VIII.2">VIII.2</option>
                                <option value="IX.1">IX.1</option>
                                <option value="IX.2">IX.2</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-subject" class="block text-sm font-medium text-gray-700 mb-2">Filter Mata Pelajaran</label>
                            <select id="filter-subject" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Semua Mata Pelajaran --</option>
                                <option>IPA</option>
                                <option>INFORMATIKA</option>
                                <option>MATEMATIKA</option>
                                <option>BAHASA INDONESIA</option>
                                <option>BAHASA INGGRIS</option>
                                <option>PENDIDIKAN AGAMA</option>
                                <option>PJOK</option>
                                <option>SENI BUDAYA</option>
                                <option>IPS</option>
                                <option>PPKN</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-name" class="block text-sm font-medium text-gray-700 mb-2">Filter Nama Siswa</label>
                            <input type="text" id="filter-name" placeholder="Ketik nama untuk mencari..." class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-1 lg:col-span-1">
                            <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-2">Filter Tanggal</label>
                            <input type="date" id="filter-date" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <!-- Student/Class summary section -->
                    <div id="recap-summary" class="hidden mb-6 bg-blue-100 border border-blue-300 p-5 rounded-lg shadow-md transition-all duration-500 ease-in-out">
                        <h3 class="text-xl font-bold text-blue-800 mb-4"><span id="summary-title">Ringkasan</span>: <span id="summary-target-name" class="text-blue-900"></span></h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-green-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-green-800" id="summary-hadir">0</p>
                                <p class="text-base font-medium text-green-700 mt-1">Hadir</p>
                            </div>
                            <div class="bg-yellow-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-yellow-800" id="summary-sakit">0</p>
                                <p class="text-base font-medium text-yellow-700 mt-1">Sakit</p>
                            </div>
                            <div class="bg-blue-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-blue-800" id="summary-izin">0</p>
                                <p class="text-base font-medium text-blue-700 mt-1">Izin</p>
                            </div>
                            <div class="bg-red-200 p-4 rounded-lg shadow-sm transform hover:scale-105 transition-transform duration-200">
                                <p class="text-3xl font-bold text-red-800" id="summary-alfa">0</p>
                                <p class="text-base font-medium text-red-700 mt-1">Alfa</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end mb-4">
                        <a href="https://docs.google.com/spreadsheets/d/145HIPY1JPtt7KLaXvvfJ6Z6D669zxhmStpbNc-5u1sw/edit?gid=0#gid=0" target="_blank" class="btn bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2.5 px-6 shadow-md flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            Lihat Data Mentah (Google Sheet)
                        </a>
                    </div>

                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NIS</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Lengkap</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Ket.</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Kelas</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Mata Pelajaran</th>
                                </tr>
                            </thead>
                            <tbody id="recap-table-body">
                                <!-- Data akan dimuat di sini -->
                            </tbody>
                            <div id="recap-loading" class="text-center py-8">
                                <p class="text-gray-500">Memuat data rekapitulasi...</p>
                            </div>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Rekap Per Mata Pelajaran View -->
            <div id="view-subject-rekap" class="view">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6 pb-3 border-b-2 border-gray-200 text-blue-700">Rekap Absensi Per Mata Pelajaran</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end mb-6">
                        <div>
                            <label for="subject-recap-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Mata Pelajaran</label>
                            <select id="subject-recap-select" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Pilih Mata Pelajaran --</option>
                                <option>IPA</option>
                                <option>INFORMATIKA</option>
                                <option>MATEMATIKA</option>
                                <option>BAHASA INDONESIA</option>
                                <option>BAHASA INGGRIS</option>
                                <option>PENDIDIKAN AGAMA</option>
                                <option>PJOK</option>
                                <option>SENI BUDAYA</option>
                                <option>IPS</option>
                                <option>PPKN</option>
                            </select>
                        </div>
                        <div>
                            <label for="subject-recap-class-select" class="block text-sm font-medium text-gray-700 mb-2">Pilih Kelas</label>
                            <select id="subject-recap-class-select" class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="">-- Pilih Kelas --</option>
                                <option value="VII.1">VII.1</option>
                                <option value="VII.2">VII.2</option>
                                <option value="VIII.1">VIII.1</option>
                                <option value="VIII.2">VIII.2</option>
                                <option value="IX.1">IX.1</option>
                                <option value="IX.2">IX.2</option>
                            </select>
                        </div>
                        <div>
                            <button id="subject-recap-button" class="btn w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-6 shadow-md flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg id="recap-icon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13l-3 3m0 0l-3-3m3 3V8m0 13a9 9 0 110-18 9 9 0 010 18z"></path></svg>
                                <span id="recap-text">Lihat Rekap</span>
                                <svg id="recap-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto table-container mt-6">
                        <table class="min-w-full bg-white">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">NIS</th>
                                    <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Nama Lengkap</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Hadir</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Sakit</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Izin</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Alfa</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Pertemuan</th>
                                    <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Persentase Kehadiran</th>
                                </tr>
                            </thead>
                            <tbody id="subject-recap-table-body">
                                <tr><td colspan="8" class="text-center py-4 text-gray-500">Pilih mata pelajaran dan kelas, lalu klik **Lihat Rekap** untuk menampilkan data.</td></tr>
                            </tbody>
                            <div id="subject-recap-loading" class="hidden text-center py-8">
                                <p class="text-gray-500">Memuat data rekapitulasi...</p>
                            </div>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA SISWA (HARAP SESUAIKAN JIKA DIPERLUKAN) ---
        const studentsData = {
            'VII.1': [
                { nis: '1', nama: 'AURA IDRIS' }, { nis: '2', nama: 'AHMAD FAUZAN' }, { nis: '3', nama: 'AHMAD HIDAYAT' },
                { nis: '4', nama: 'ANUGRAH HAYU' }, { nis: '5', nama: 'ATIKA DEFI' }, { nis: '6', nama: 'AZILA AZZAHRA' },
                { nis: '7', nama: 'KHASRAPUL HABIB' }, { nis: '8', nama: 'MUH.AIMAN SYAH' }, { nis: '9', nama: 'MUH.ALIF' },
                { nis: '10', nama: 'MUH.ANUGRAH' }, { nis: '11', nama: 'MUH.ARYA' }, { nis: '12', nama: 'MUH.RAMADHAN RUSMAN' },
                { nis: '13', nama: 'MUHAMMAD IMRAN' }, { nis: '14', nama: 'NABILA' }, { nis: '15', nama: 'NUR ANIDA NURDIN' },
                { nis: '16', nama: 'NUR AZILAH' }, { nis: '17', nama: 'NURUL ANNISA' }, { nis: '18', nama: 'RITA PARADIBA' },
                { nis: '19', nama: 'SUKUR' }, { nis: '20', nama: 'SYAFIRA' }, { nis: '21', nama: 'ZAKHWAN AHMAD NOVAL' },
                { nis: '22', nama: 'NUR AKILA' },
                { nis: '23', nama: 'MUH. FIKRI AQLANY' }
            ],
            'VII.2': [
                { nis: '1', nama: 'ALIM FIKRI' }, { nis: '2', nama: 'ALYA ARFAN' }, { nis: '3', nama: 'ANUGRAH NURUSTAZAH' },
                { nis: '4', nama: 'DIAN VIRGINIA ARNA' }, { nis: '5', nama: 'DUL JALAL WAL IKRAM' }, { nis: '6', nama: 'JASYAN GALBYANA' },
                { nis: '7', nama: 'MUH.ADAM AL FATIH' }, { nis: '8', nama: 'MUH.FARDAN' }, { nis: '9', nama: 'MUH.HARDYAN' },
                { nis: '10', nama: 'MUH.IKZAN' }, { nis: '11', nama: 'MUH.MULIADI' }, { nis: '12', nama: 'MUH.REZKY' },
                { nis: '13', nama: 'MUHAMMAD DWI FARHAN' }, { nis: '14', nama: 'MUHAMMAD FADLI ADRIAN' }, { nis: '15', nama: 'MUHAMMAD SULFIANDI' },
                { nis: '16', nama: 'NASRAH' }, { nis: '17', nama: 'NIRMADANI SAFITRI' }, { nis: '18', nama: 'NUR AZMITA' },
                { nis: '19', nama: 'NURHALIZA' }, { nis: '20', nama: 'SALDI FEBRIANSA' }, { nis: '21', nama: 'YENI ANGRENI' }, { nis: '22', nama: 'ZASKIA GAMA' }
            ],
            'VIII.1': [
                { nis: '2024342', nama: 'A. BESSE INTAN GALI GALI' }, { nis: '2024343', nama: 'ALDI' }, { nis: '2024344', nama: 'ANDI CAHAYA RAMADHANI, AJ' },
                { nis: '2024345', nama: 'ANDI MAHERA' }, { nis: '2024346', nama: 'FAISAL' }, { nis: '2024347', nama: 'FIRMANSYAH' },
                { nis: '2024348', nama: 'HASTATI' }, { nis: '2024349', nama: 'IRFANSYAH IBRAHIM' }, { nis: '2024350', nama: 'LESTARI' },
                { nis: '2024351', nama: 'M. RIJAL' }, { nis: '2024352', nama: 'MUH. MULYA' }, { nis: '2024353', nama: 'MUHAMMAD ASWAR ALHABSI' },
                { nis: '2024354', nama: 'MUHAMMAD FIKRAN' }, { nis: '2024355', nama: 'MUHAMMAD RIFKI LUKMAN' }, { nis: '2024356', nama: 'NURWAVIA' },
                { nis: '2024357', nama: 'PUTRI YASMIN' }, { nis: '2024358', nama: 'RIZKI FAHRI ANUGRAH' }, { nis: '2024359', nama: 'SAMSIR' },
                { nis: '2024360', nama: 'SITI NUR AZZAHRAH' }, { nis: '2024361', nama: 'SITI NURUL SYAFIQAH' }, { nis: '2024379', nama: 'ZASKIA APRILIA' }
            ],
            'VIII.2': [
                { nis: '2024361', nama: 'AENI' }, { nis: '2024362', nama: 'AL IKRAM' }, { nis: '2024363', nama: 'AUREL' },
                { nis: '2024364', nama: 'DEVI ALDIANTI' }, { nis: '2024365', nama: 'ERSYA ANATASYA' }, { nis: '2024366', nama: 'HALIFAH AMIRUDDIN' },
                { nis: '2024367', nama: 'INTAN' }, { nis: '2024368', nama: 'MUH. ALIF' }, { nis: '2024369', nama: 'MUHAMMAD AIMAN' },
                { nis: '2024370', nama: 'MUHAMMAD NASRIL' }, { nis: '2024371', nama: 'MUHAMMAD REZA ANWAR' }, { nis: '2024372', nama: 'NABILA' },
                { nis: '2024373', nama: 'NATASYA' }, { nis: '2024374', nama: 'NURUL AINUN SAKINAH' }, { nis: '2024375', 'nama': 'PERDI' },
                { nis: '2024376', nama: 'REZKY' }, { nis: '2024377', nama: 'SHOHIH MUSLIM ABI AKBAR' }, { nis: '2024378', nama: 'TINA INDRISARI' },
                { nis: '2025378', nama: 'ABDUL MULIADIL' }, { nis: '2025376', nama: 'MUHAMMAD HAIKAL' }
            ],
            'IX.1': [
                { nis: '2024339', nama: 'ADELIA MARWAH' }, { nis: '2023335', nama: 'AFGAN' }, { nis: '2023296', nama: 'ALFIYA SYAHRANI' },
                { nis: '2023330', nama: 'ALYA REGINA' }, { nis: '2023298', nama: 'ARIF' }, { nis: '2023300', nama: 'BUNGA CITRA LESTARI' },
                { nis: '2023303', nama: 'IKRAM' }, { nis: '2023307', nama: 'MUH.ANDRI ILHAM' }, { nis: '2023331', nama: 'MUH.DAVID' },
                { nis: '2023308', nama: 'MUH.SYASWI GAISAN' }, { nis: '2023329', nama: 'MUHAMMAD RESKI' }, { nis: '2024338', nama: 'NUR FITRI' },
                { nis: '2023316', nama: 'NUR AENI' }, { nis: '2023319', nama: 'NUR HIKMAH' }, { nis: '2023321', nama: 'NURUL AZIZAH SULTAN' },
                { nis: '2023322', nama: 'NURUL MUTMAINNA' }, { nis: '2023323', nama: 'PATIMURA' }, { nis: '2023324', nama: 'RAHMANIA' },
                { nis: '2023326', nama: 'SALSABILA' }, { nis: '2023332', nama: 'SATRIADI' }
            ],
            'IX.2': [
                { nis: '2023295', nama: 'AISYAH NUR MAULIDYA' }, { nis: '2023297', nama: 'ANDI AHMAD DENI' }, { nis: '2023299', nama: 'AURAH ZAKINA' },
                { nis: '2024337', nama: 'HAFIZHA TULFALIHA' }, { nis: '2023302', nama: 'HUSNUL MUBARAK' }, { nis: '2023304', nama: 'JUMALIA' },
                { nis: '2023306', nama: 'MAWAR INDAH LESTARI' }, { nis: '2023310', nama: 'MUHAMMAD ADITYA' }, { nis: '2023311', nama: 'MUHAMMAD DAVID' },
                { nis: '2023312', nama: 'MUHAMMAD FAUSY' }, { nis: '2023313', nama: 'MUHD.RAFI' }, { nis: '2023314', nama: 'MULYANI SAFITRA' },
                { nis: '2023318', nama: 'NUR HASNA' }, { nis: '2023320', nama: 'NUR SAHIRA' }, { nis: '2023325', nama: 'RAHMAT HIDAYAT' },
                { nis: '2023327', nama: 'SASKIA RAMADANI' }, { nis: '2024340', nama: 'MUH. RIZKY' }, { nis: '2024372', nama: 'Muh Fauzan' },
                { nis: '2024371', nama: 'FITRA RAMADANI' }, { nis: '2024373', nama: 'SISKA' }
            ]
        };
        
        // Gabungkan semua siswa ke dalam satu array untuk memudahkan pemrosesan rekap
        const allStudents = Object.values(studentsData).flat();
        
        const allClasses = Object.keys(studentsData);

        // --- KONFIGURASI ---
        // URL Google Apps Script Anda yang baru
        const googleScriptURL = 'https://script.google.com/macros/s/AKfycbx53NQBkdHJV-G4AlCfvdWhcsFe_EKSEj47vyVxQImIqgnXpMqy1hgULOgqACCbVW8zgQ/exec';
        
        // URL untuk rekap data dari Google Sheet (CSV).
        // URL ini telah disesuaikan agar bisa mengambil data mentah (CSV).
        const googleSheetRecapURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ27ncSSFBRM9qe1-Oc4Q4OL2USYZ5-zDgZS7Osyj7Yywv-BRda3ZLekf7fQPH-NO6d5E58hMbn2uuB/pub?gid=0&single=true&output=csv';
        // URL untuk melihat Google Sheet mentah Anda
        const rawGoogleSheetURL = 'https://docs.google.com/spreadsheets/d/145HIPY1JPtt7KLaXvvfJ6Z6D669zxhmStpbNc-5u1sw/edit?gid=0#gid=0';

        // --- DOM ELEMENTS ---
        const classSelect = document.getElementById('class-select');
        const subjectSelect = document.getElementById('subject-select');
        const studentListContainer = document.getElementById('student-list-container');
        const attendanceForm = document.getElementById('attendance-form');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const submitSpinner = document.getElementById('submit-spinner');
        const statusMessage = document.getElementById('status-message');
        const dateInput = document.getElementById('date-input');

        const navAbsen = document.getElementById('nav-absen');
        const navRekap = document.getElementById('nav-rekap');
        const navSubjectRecap = document.getElementById('nav-subject-rekap');
        const viewAbsen = document.getElementById('view-absen');
        const viewRekap = document.getElementById('view-rekap');
        const viewSubjectRecap = document.getElementById('view-subject-rekap');

        const recapTableBody = document.getElementById('recap-table-body');
        const recapLoading = document.getElementById('recap-loading');
        const filterClass = document.getElementById('filter-class');
        const filterSubject = document.getElementById('filter-subject');
        const filterName = document.getElementById('filter-name');
        const filterDate = document.getElementById('filter-date');
        const recapSummary = document.getElementById('recap-summary');
        const summaryTitle = document.getElementById('summary-title');
        const summaryTargetName = document.getElementById('summary-target-name');
        const summaryHadir = document.getElementById('summary-hadir');
        const summarySakit = document.getElementById('summary-sakit');
        const summaryIzin = document.getElementById('summary-izin');
        const summaryAlfa = document.getElementById('summary-alfa');
        
        const subjectRecapSelect = document.getElementById('subject-recap-select');
        const subjectRecapClassSelect = document.getElementById('subject-recap-class-select');
        const subjectRecapButton = document.getElementById('subject-recap-button');
        const subjectRecapTableBody = document.getElementById('subject-recap-table-body');
        const subjectRecapLoading = document.getElementById('subject-recap-loading');
        const recapSpinner = document.getElementById('recap-spinner');
        const recapText = document.getElementById('recap-text');
        
        let allRecapData = [];

        // --- FUNGSI JAM & TANGGAL (WITA) ---
        /**
         * Mengupdate tampilan jam dan tanggal di header.
         * Menampilkan waktu dalam WITA (Waktu Indonesia Tengah).
         */
        function updateClock() {
            const timeDisplay = document.getElementById('time-display');
            const dateDisplay = document.getElementById('date-display');
            
            const now = new Date();
            const optionsTime = { timeZone: 'Asia/Makassar', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            const optionsDate = { timeZone: 'Asia/Makassar', weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };

            if (timeDisplay) timeDisplay.textContent = `WITA: ${new Intl.DateTimeFormat('id-ID', optionsTime).format(now)}`;
            if (dateDisplay) dateDisplay.textContent = new Intl.DateTimeFormat('id-ID', optionsDate).format(now);
        }

        // --- FUNGSI UTAMA APLIKASI ---

        /**
         * Mengisi daftar siswa berdasarkan kelas yang dipilih.
         * Mengaktifkan/menonaktifkan tombol kirim sesuai kondisi.
         */
        function populateStudentList() {
            const selectedClass = classSelect.value;
            if (!selectedClass) {
                if (studentListContainer) studentListContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Silakan pilih kelas untuk menampilkan daftar siswa.</p>';
                if (submitButton) submitButton.disabled = true;
                return;
            }

            const students = studentsData[selectedClass];
            const statusOptions = ['Hadir', 'Sakit', 'Izin', 'Alfa'];

            let tableHTML = `
                <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="w-12 px-4 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">No</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">NIS</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nama Lengkap</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
            `;

            students.forEach((student, index) => {
                tableHTML += `
                    <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-gray-100">
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 text-center">${index + 1}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">${student.nis}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500">
                            <div class="flex items-center justify-center space-x-2">
                `;
                statusOptions.forEach(status => {
                    const isChecked = status === 'Hadir'; // Default to Hadir for new selection
                    tableHTML += `
                                <label class="custom-radio-label">
                                    <input type="radio" name="attendance-${student.nis}" value="${status}" ${isChecked ? 'checked' : ''} required>
                                    <span class="custom-radio-indicator">${status}</span>
                                </label>
                    `;
                });
                tableHTML += `
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            if (studentListContainer) studentListContainer.innerHTML = tableHTML;
            if (submitButton) submitButton.disabled = false;
        }

        /**
         * Menangani pengiriman form absensi.
         * Mengumpulkan data dan mengirim setiap catatan siswa ke Google Apps Script.
         */
        if (attendanceForm) {
            attendanceForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (submitButton) submitButton.disabled = true;
                if (submitText) submitText.classList.add('hidden');
                if (submitSpinner) submitSpinner.classList.remove('hidden');
                if (statusMessage) statusMessage.textContent = ''; // Clear previous messages

                const selectedClass = classSelect.value;
                const selectedSubject = subjectSelect.value;
                const selectedDate = dateInput.value;

                if (!selectedClass || !selectedSubject || !selectedDate) {
                    if (statusMessage) {
                        statusMessage.textContent = 'Harap lengkapi semua bidang (Kelas, Mata Pelajaran, Tanggal).';
                        statusMessage.className = 'mt-6 text-center text-lg text-red-600 font-semibold';
                    }
                    if (submitButton) submitButton.disabled = false;
                    if (submitText) submitText.classList.remove('hidden');
                    if (submitSpinner) submitSpinner.classList.add('hidden');
                    return;
                }

                const students = studentsData[selectedClass];
                const attendanceRecords = [];

                students.forEach(student => {
                    const statusElement = document.querySelector(`input[name="attendance-${student.nis}"]:checked`);
                    if (statusElement) {
                        attendanceRecords.push({
                            nis: student.nis,
                            nama: student.nama,
                            kelas: selectedClass,
                            mata_pelajaran: selectedSubject,
                            tanggal: selectedDate,
                            keterangan: statusElement.value
                        });
                    }
                });

                if (attendanceRecords.length === 0) {
                    if (statusMessage) {
                        statusMessage.textContent = 'Tidak ada data absensi yang dipilih. Harap pilih status absensi untuk setiap siswa.';
                        statusMessage.className = 'mt-6 text-center text-lg text-red-600 font-semibold';
                    }
                    if (submitButton) submitButton.disabled = false;
                    if (submitText) submitText.classList.remove('hidden');
                    if (submitSpinner) submitSpinner.classList.add('hidden');
                    return;
                }
                
                let successCount = 0;
                let errorCount = 0;

                try {
                    for (const record of attendanceRecords) {
                        const params = new URLSearchParams({
                            'NIS': record.nis,
                            'Nama Lengkap': record.nama,
                            'Tanggal Absen': record.tanggal,
                            'Keterangan': record.keterangan,
                            'Kelas': record.kelas,
                            'Mata Pelajaran': record.mata_pelajaran
                        });

                        // Tampilkan status pengiriman per siswa
                        if (statusMessage) {
                             statusMessage.textContent = `Mengirim data absensi untuk ${record.nama}...`;
                             statusMessage.className = 'mt-6 text-center text-lg text-blue-600 font-semibold';
                        }


                        // Mengirim data sebagai form URL-encoded
                        const response = await fetch(googleScriptURL, {
                            method: 'POST',
                            body: params
                        });

                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    }
                    
                    // Tampilkan pesan akhir setelah semua permintaan selesai
                    if (errorCount === 0) {
                        if (statusMessage) {
                             statusMessage.textContent = `Absensi untuk ${successCount} siswa berhasil disimpan!`;
                             statusMessage.className = 'mt-6 text-center text-lg text-green-600 font-semibold';
                        }
                        attendanceForm.reset(); // Reset form
                        if (dateInput) {
                            const today = new Date();
                            const yyyy = today.getFullYear();
                            const mm = String(today.getMonth() + 1).padStart(2, '0');
                            const dd = String(today.getDate()).padStart(2, '0');
                            dateInput.value = `${yyyy}-${mm}-${dd}`;
                        }
                        populateStudentList(); // Re-populate to clear selections
                    } else {
                        if (statusMessage) {
                             statusMessage.textContent = `Absensi berhasil disimpan untuk ${successCount} siswa, tetapi gagal untuk ${errorCount} siswa.`;
                             statusMessage.className = 'mt-6 text-center text-lg text-yellow-600 font-semibold';
                        }
                    }

                } catch (error) {
                    console.error('Error submitting attendance:', error);
                    if (statusMessage) {
                        statusMessage.textContent = 'Terjadi kesalahan saat menyimpan absensi. Silakan coba lagi.';
                        statusMessage.className = 'mt-6 text-center text-lg text-red-600 font-semibold';
                    }
                } finally {
                    if (submitButton) submitButton.disabled = false;
                    if (submitText) submitText.classList.remove('hidden');
                    if (submitSpinner) submitSpinner.classList.add('hidden');
                }
            });
        }


        /**
         * Berpindah antar tampilan yang berbeda.
         * @param {string} viewId - ID tampilan yang akan diaktifkan.
         */
        function switchView(viewId) {
            // Sembunyikan semua tampilan dengan aman
            if (viewAbsen) viewAbsen.classList.remove('active');
            if (viewRekap) viewRekap.classList.remove('active');
            if (viewSubjectRecap) viewSubjectRecap.classList.remove('active');
            
            // Atur ulang tombol navigasi dengan aman
            const navButtons = [navAbsen, navRekap, navSubjectRecap];
            navButtons.forEach(btn => {
                if (btn) {
                    btn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'shadow-md');
                    btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
                }
            });

            // Aktifkan tampilan yang dipilih dan tombolnya dengan aman
            const activeView = document.getElementById(viewId);
            if (activeView) {
                activeView.classList.add('active');
            }

            const navId = 'nav-' + viewId.split('-')[1];
            const activeButton = document.getElementById(navId);
            if (activeButton) {
                activeButton.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'shadow-md');
                activeButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            }

            // Muat data saat beralih ke tampilan rekap
            if (viewId === 'view-rekap' || viewId === 'view-subject-rekap') {
                loadRecapData();
            }
        }

        // Event listeners untuk tombol navigasi
        if (navAbsen) navAbsen.addEventListener('click', () => switchView('view-absen'));
        if (navRekap) navRekap.addEventListener('click', () => switchView('view-rekap'));
        if (navSubjectRecap) navSubjectRecap.addEventListener('click', () => switchView('view-subject-rekap'));

        /**
         * Mengambil data rekap absensi dari Google Sheet yang diekspor sebagai CSV.
         */
        async function loadRecapData() {
            // Hanya tampilkan loading jika tabel tidak berisi data.
            const isDailyRecapEmpty = recapTableBody && recapTableBody.getElementsByTagName('tr').length === 0;
            const isSubjectRecapEmpty = subjectRecapTableBody && subjectRecapTableBody.getElementsByTagName('tr').length <= 1; // 1 for the initial message

            if (recapLoading && isDailyRecapEmpty) recapLoading.classList.remove('hidden');
            if (subjectRecapLoading) subjectRecapLoading.classList.add('hidden'); // Sembunyikan loading untuk rekap subjek awal

            if (recapTableBody) recapTableBody.innerHTML = '';
            
            try {
                const response = await fetch(googleSheetRecapURL);
                const csvText = await response.text();
                allRecapData = parseCSV(csvText);
                renderRecapTable(); // Tampilkan tabel rekap harian secara otomatis
                
                // Tambahkan pesan default untuk rekap per mata pelajaran
                if(subjectRecapTableBody){
                    subjectRecapTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Pilih mata pelajaran dan kelas, lalu klik **Lihat Rekap** untuk menampilkan data.</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading recap data:', error);
                const errorMessage = `<tr><td colspan="8" class="text-center py-4 text-red-500">Gagal memuat data rekapitulasi.</td></tr>`;
                if (recapTableBody) recapTableBody.innerHTML = errorMessage;
                if (subjectRecapTableBody) subjectRecapTableBody.innerHTML = errorMessage;
            } finally {
                if (recapLoading) recapLoading.classList.add('hidden');
                if (subjectRecapLoading) subjectRecapLoading.classList.add('hidden');
            }
        }

        /**
         * Mengurai teks CSV menjadi array objek.
         * Mengasumsikan baris pertama adalah header.
         * @param {string} csv - Data CSV sebagai string.
         * @returns {Array<Object>} Array objek yang mewakili data CSV.
         */
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== ''); // Filter baris kosong
            if (lines.length <= 1) return []; // Return empty array if no data or only headers

            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    let row = {};
                    headers.forEach((header, index) => {
                        row[header.toLowerCase().replace(/\s/g, '_')] = values[index]; // Ubah header ke snake_case
                    });
                    data.push(row);
                }
            }
            return data;
        }

        /**
         * Menampilkan tabel rekap harian dan mengupdate ringkasan berdasarkan data yang difilter.
         */
        function renderRecapTable() {
            let filteredData = [...allRecapData]; // Buat salinan yang dapat diubah

            const selectedClass = filterClass ? filterClass.value : '';
            const selectedSubject = filterSubject ? filterSubject.value : '';
            const searchName = filterName ? filterName.value.toLowerCase() : '';
            const selectedDate = filterDate ? filterDate.value : '';

            if (selectedClass) {
                filteredData = filteredData.filter(record => record.kelas === selectedClass);
            }
            if (selectedSubject) {
                filteredData = filteredData.filter(record => record.mata_pelajaran === selectedSubject);
            }
            if (searchName) {
                filteredData = filteredData.filter(record => record.nama_lengkap.toLowerCase().includes(searchName));
            }
            if (selectedDate) {
                filteredData = filteredData.filter(record => record.tanggal_absen === selectedDate);
            }

            if (recapTableBody) recapTableBody.innerHTML = ''; // Hapus tabel sebelum menampilkan
            if (filteredData.length === 0) {
                if (recapTableBody) recapTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Tidak ada data absensi yang ditemukan.</td></tr>`;
                if (recapSummary) recapSummary.classList.add('hidden');
            } else {
                filteredData.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${record.nis}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.nama_lengkap}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.tanggal_absen}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-semibold ${
                            record.keterangan === 'Hadir' ? 'text-green-600' :
                            record.keterangan === 'Sakit' ? 'text-yellow-600' :
                            record.keterangan === 'Izin' ? 'text-blue-600' :
                            record.keterangan === 'Alfa' ? 'text-red-600' : ''
                        }">${record.keterangan}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.kelas}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.mata_pelajaran}</td>
                    `;
                    if (recapTableBody) recapTableBody.appendChild(row);
                });
                updateRecapSummary(filteredData, selectedClass, searchName);
            }
        }

        /**
         * Menampilkan tabel rekap per mata pelajaran dengan merangkum absensi setiap siswa.
         */
        async function renderSubjectRecapTable() {
            if (subjectRecapButton) subjectRecapButton.disabled = true;
            if (recapText) recapText.classList.add('hidden');
            if (recapSpinner) recapSpinner.classList.remove('hidden');

            const selectedSubject = subjectRecapSelect ? subjectRecapSelect.value : '';
            const selectedClass = subjectRecapClassSelect ? subjectRecapClassSelect.value : '';

            if (subjectRecapTableBody) subjectRecapTableBody.innerHTML = ''; // Hapus tabel
            if (subjectRecapLoading) subjectRecapLoading.classList.add('hidden');
            
            if (!selectedSubject || !selectedClass) {
                if (subjectRecapTableBody) subjectRecapTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-500">Pilih mata pelajaran dan kelas terlebih dahulu.</td></tr>`;
                if (subjectRecapButton) subjectRecapButton.disabled = !subjectRecapSelect.value || !subjectRecapClassSelect.value;
                if (recapText) recapText.classList.remove('hidden');
                if (recapSpinner) recapSpinner.classList.add('hidden');
                return;
            }

            if (subjectRecapLoading) subjectRecapLoading.classList.remove('hidden');

            // Tunggu sebentar untuk memberi kesan memuat
            await new Promise(resolve => setTimeout(resolve, 500));

            const filteredBySubjectAndClass = allRecapData.filter(record =>
                record.mata_pelajaran === selectedSubject && record.kelas === selectedClass
            );
            
            // Kelompokkan absensi berdasarkan siswa
            const studentSummary = {};

            // Inisialisasi semua siswa untuk tabel ringkasan
            const studentsInClass = studentsData[selectedClass];
            if (studentsInClass) {
                studentsInClass.forEach(student => {
                    studentSummary[student.nis] = {
                        nis: student.nis,
                        nama: student.nama,
                        kelas: selectedClass,
                        Hadir: 0,
                        Sakit: 0,
                        Izin: 0,
                        Alfa: 0
                    };
                });
            }
            
            // Isi ringkasan dengan data aktual dari catatan yang difilter
            filteredBySubjectAndClass.forEach(record => {
                if (studentSummary[record.nis] && studentSummary[record.nis].hasOwnProperty(record.keterangan)) {
                    studentSummary[record.nis][record.keterangan]++;
                }
            });
            
            const studentsWithAttendance = Object.values(studentSummary).filter(student =>
                student.Hadir > 0 || student.Sakit > 0 || student.Izin > 0 || student.Alfa > 0
            );

            // Tampilkan tabel ringkasan
            if (studentsWithAttendance.length === 0) {
                 if (subjectRecapTableBody) subjectRecapTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500">Tidak ada data absensi yang ditemukan untuk mata pelajaran dan kelas yang dipilih.</td></tr>`;
            } else {
                let sortedStudents = studentsWithAttendance.sort((a,b) => a.nama.localeCompare(b.nama));
                
                let tableHTML = '';
                sortedStudents.forEach((student, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    // Hitung total pertemuan dan persentase kehadiran
                    const totalPertemuan = student.Hadir + student.Sakit + student.Izin + student.Alfa;
                    const persentaseKehadiran = totalPertemuan > 0 ? ((student.Hadir / totalPertemuan) * 100).toFixed(2) : 0;
                    
                    // Atur warna berdasarkan persentase
                    let persentaseColorClass = 'text-gray-800';
                    if (persentaseKehadiran >= 80) {
                        persentaseColorClass = 'text-green-600 font-bold';
                    } else if (persentaseKehadiran >= 60) {
                        persentaseColorClass = 'text-yellow-600 font-bold';
                    } else {
                        persentaseColorClass = 'text-red-600 font-bold';
                    }

                    tableHTML += `
                        <tr class="hover:bg-gray-100 ${rowClass}">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${student.nis}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${student.nama}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold text-green-600">${student.Hadir}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold text-yellow-600">${student.Sakit}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold text-blue-600">${student.Izin}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold text-red-600">${student.Alfa}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-500">${totalPertemuan}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-center ${persentaseColorClass}">${persentaseKehadiran}%</td>
                        </tr>
                    `;
                });
                if (subjectRecapTableBody) subjectRecapTableBody.innerHTML = tableHTML;
            }
            if (subjectRecapLoading) subjectRecapLoading.classList.add('hidden');
            if (subjectRecapButton) subjectRecapButton.disabled = !subjectRecapSelect.value || !subjectRecapClassSelect.value;
            if (recapText) recapText.classList.remove('hidden');
            if (recapSpinner) recapSpinner.classList.add('hidden');
        }
        
        /**
         * Menemukan kelas seorang siswa berdasarkan NIS mereka.
         * @param {string} nis - NIS siswa.
         * @returns {string} Nama kelas atau 'N/A' jika tidak ditemukan.
         */
        function getStudentClass(nis) {
            for (const classname in studentsData) {
                const found = studentsData[classname].find(student => student.nis === nis);
                if (found) {
                    return classname;
                }
            }
            return 'N/A';
        }

        /**
         * Mengupdate bagian ringkasan dengan jumlah absensi.
         * @param {Array<Object>} data - Data absensi yang sudah difilter.
         * @param {string} selectedClass - Kelas yang saat ini dipilih untuk difilter.
         * @param {string} searchName - Nama siswa yang saat ini dicari.
         */
        function updateRecapSummary(data, selectedClass, searchName) {
            const counts = { Hadir: 0, Sakit: 0, Izin: 0, Alfa: 0 };
            data.forEach(record => {
                if (counts.hasOwnProperty(record.keterangan)) {
                    counts[record.keterangan]++;
                }
            });

            if (summaryHadir) summaryHadir.textContent = counts.Hadir;
            if (summarySakit) summarySakit.textContent = counts.Sakit;
            if (summaryIzin) summaryIzin.textContent = counts.Izin;
            if (summaryAlfa) summaryAlfa.textContent = counts.Alfa;

            if (searchName) {
                if (summaryTitle) summaryTitle.textContent = 'Ringkasan Absensi Siswa';
                if (summaryTargetName) summaryTargetName.textContent = filterName.value;
            } else if (selectedClass) {
                if (summaryTitle) summaryTitle.textContent = 'Ringkasan Absensi Kelas';
                if (summaryTargetName) summaryTargetName.textContent = selectedClass;
            } else {
                if (summaryTitle) summaryTitle.textContent = 'Ringkasan Absensi Keseluruhan';
                if (summaryTargetName) summaryTargetName.textContent = ''; // Hapus jika tidak ada kelas atau nama spesifik yang difilter
            }
            if (recapSummary) recapSummary.classList.remove('hidden');
        }


        // Event listeners untuk filter rekap
        if (filterClass) filterClass.addEventListener('change', renderRecapTable);
        if (filterSubject) filterSubject.addEventListener('change', renderRecapTable);
        if (filterName) filterName.addEventListener('input', renderRecapTable); // Gunakan 'input' untuk pemfilteran real-time
        if (filterDate) filterDate.addEventListener('change', renderRecapTable);
        
        // Event listener untuk tombol rekap per mata pelajaran yang baru
        if (subjectRecapButton) subjectRecapButton.addEventListener('click', renderSubjectRecapTable);
        
        // Event listener untuk menonaktifkan tombol jika tidak ada mata pelajaran atau kelas yang dipilih
        const updateSubjectRecapButtonState = () => {
             if (subjectRecapButton) {
                 const isSubjectSelected = !!subjectRecapSelect.value;
                 const isClassSelected = !!subjectRecapClassSelect.value;
                 subjectRecapButton.disabled = !(isSubjectSelected && isClassSelected);
             }
        };

        if (subjectRecapSelect) subjectRecapSelect.addEventListener('change', updateSubjectRecapButtonState);
        if (subjectRecapClassSelect) subjectRecapClassSelect.addEventListener('change', updateSubjectRecapButtonState);
        

        // --- INISIALISASI ---
        document.addEventListener('DOMContentLoaded', () => {
            // Atur tanggal saat ini ke input tanggal
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Bulan adalah 0-indexed
            const dd = String(today.getDate()).padStart(2, '0');
            if (dateInput) dateInput.value = `${yyyy}-${mm}-${dd}`;

            updateClock(); // Pembaruan jam awal
            setInterval(updateClock, 1000); // Perbarui jam setiap detik

            populateStudentList(); // Isi daftar siswa saat muat awal
            
            // Atur tombol navigasi awal yang aktif
            if (navAbsen) {
                navAbsen.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'font-semibold', 'py-3', 'px-6', 'shadow-md');
                navAbsen.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            }
            
            // Nonaktifkan tombol rekap per mata pelajaran di awal
            updateSubjectRecapButtonState();
        });

        // Event listener untuk perubahan pilihan kelas
        if (classSelect) classSelect.addEventListener('change', populateStudentList);
    </script>
</body>
</html>
